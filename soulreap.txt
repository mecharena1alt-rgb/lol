-- services
local replicated_storage = game:GetService("ReplicatedStorage")
local user_input_service = game:GetService("UserInputService")
local core_gui = game:GetService("CoreGui")
local run_service = game:GetService("RunService")

-- path to config
local ability_config_module = replicated_storage:WaitForChild("Ability"):WaitForChild("AbilityConfig")

-- ui construction
local screen_gui = Instance.new("ScreenGui")
screen_gui.Name = "SoulModGUI"
screen_gui.Parent = core_gui
screen_gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local main_frame = Instance.new("Frame")
main_frame.Name = "MainFrame"
main_frame.Size = UDim2.new(0, 180, 0, 60)
main_frame.Position = UDim2.new(0.05, 0, 0.5, -30)
main_frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
main_frame.BorderSizePixel = 0
main_frame.Active = true
main_frame.Draggable = true
main_frame.Parent = screen_gui

local ui_corner = Instance.new("UICorner")
ui_corner.CornerRadius = UDim.new(0, 8)
ui_corner.Parent = main_frame

local title_label = Instance.new("TextLabel")
title_label.Name = "TitleLabel"
title_label.Size = UDim2.new(1, 0, 0, 25)
title_label.BackgroundTransparency = 1
title_label.Text = "config modifier"
title_label.TextColor3 = Color3.fromRGB(255, 255, 255)
title_label.Font = Enum.Font.GothamBold
title_label.TextSize = 14
title_label.Parent = main_frame

local toggle_btn = Instance.new("TextButton")
toggle_btn.Name = "ToggleBtn"
toggle_btn.Size = UDim2.new(1, -10, 0, 25)
toggle_btn.Position = UDim2.new(0, 5, 0, 30)
toggle_btn.BackgroundColor3 = Color3.fromRGB(200, 50, 50) -- red (off)
toggle_btn.Text = "MODS: OFF"
toggle_btn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggle_btn.Font = Enum.Font.Gotham
toggle_btn.TextSize = 13
toggle_btn.Parent = main_frame

local btn_corner = Instance.new("UICorner")
btn_corner.CornerRadius = UDim.new(0, 6)
btn_corner.Parent = toggle_btn

-- state
local is_enabled = false
local loop_connection = nil

-- store original values to be polite when turning it off
local original_values = {
    SoulLifetime = 4,
    SoulReapTime = 3
}

-- logic
local function update_config(enable)
    -- require the module to get the live table
    local success, config_table = pcall(function()
        return require(ability_config_module)
    end)

    if not success then
        warn("failed to require config module. anti-cheat or path issue?")
        return
    end

    if enable then
        -- set to god mode values
        config_table.SoulLifetime = 9999
        config_table.SoulReapTime = 9999
        print("values patched to 9999")
    else
        -- restore defaults
        config_table.SoulLifetime = original_values.SoulLifetime
        config_table.SoulReapTime = original_values.SoulReapTime
        print("values restored")
    end
end

-- loop logic (some games reset modules, so we force it)
local function start_loop()
    if loop_connection then return end
    
    update_config(true) -- run immediately
    
    -- keep forcing it just in case the game tries to change it back
    loop_connection = run_service.Heartbeat:Connect(function()
        if is_enabled then
            local success, config_table = pcall(function() return require(ability_config_module) end)
            if success then
                if config_table.SoulLifetime ~= 9999 then config_table.SoulLifetime = 9999 end
                if config_table.SoulReapTime ~= 9999 then config_table.SoulReapTime = 9999 end
            end
        end
    end)
end

local function stop_loop()
    if loop_connection then
        loop_connection:Disconnect()
        loop_connection = nil
    end
    update_config(false) -- revert values
end

-- toggle logic
toggle_btn.MouseButton1Click:Connect(function()
    is_enabled = not is_enabled
    
    if is_enabled then
        toggle_btn.Text = "MODS: ON"
        toggle_btn.BackgroundColor3 = Color3.fromRGB(50, 200, 50) -- green
        start_loop()
    else
        toggle_btn.Text = "MODS: OFF"
        toggle_btn.BackgroundColor3 = Color3.fromRGB(200, 50, 50) -- red
        stop_loop()
    end
end)

-- visibility toggle (press P)
user_input_service.InputBegan:Connect(function(input, game_processed)
    if not game_processed and input.KeyCode == Enum.KeyCode.P then
        main_frame.Visible = not main_frame.Visible
    end
end)

print("module modifier loaded. press P to toggle gui.")
