-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Player
local player = Players.LocalPlayer

-- UI Construction
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SmartKillGui"
screenGui.Parent = CoreGui
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 180, 0, 65) 
mainFrame.Position = UDim2.new(0.05, 0, 0.5, -32)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 8)
uiCorner.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "TitleLabel"
titleLabel.Size = UDim2.new(1, 0, 0, 25)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Round Start Sniper"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.Parent = mainFrame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Name = "ToggleBtn"
toggleBtn.Size = UDim2.new(1, -10, 0, 30)
toggleBtn.Position = UDim2.new(0, 5, 0, 30)
toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
toggleBtn.Text = "SNIPER: OFF"
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.Font = Enum.Font.Gotham
toggleBtn.TextSize = 13
toggleBtn.Parent = mainFrame

local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0, 6)
btnCorner.Parent = toggleBtn

-- State
local isEnabled = false
local connection = nil -- Stores the Anchor listener

-- Logic
local function getRemote()
    return ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("ShootGun")
end

local function executeKill()
    if not isEnabled then return end
    
    local remote = getRemote()
    if not remote then return end

    local myChar = player.Character
    local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")
    
    if not myRoot then return end

    local enemies = Players:GetPlayers()
    local killCount = 0

    for _, enemy in ipairs(enemies) do
        if enemy ~= player and enemy.Character then
            local head = enemy.Character:FindFirstChild("Head")
            
            if head then
                local origin = myRoot.Position
                local targetPos = head.Position
                
                -- Triple tap to ensure packet delivery
                for i = 1, 3 do
                    remote:FireServer(origin, targetPos, head, targetPos)
                end
                killCount = killCount + 1
            end
        end
    end
    
    if killCount > 0 then
        toggleBtn.Text = "KILLED " .. killCount .. " PLAYERS"
        task.delay(2, function()
            if isEnabled then
                toggleBtn.Text = "SNIPER: READY"
            else
                toggleBtn.Text = "SNIPER: OFF"
            end
        end)
    end
end

local function setupCharacter(char)
    -- Clean up old connection if it exists
    if connection then 
        connection:Disconnect() 
        connection = nil
    end

    local root = char:WaitForChild("HumanoidRootPart", 10)
    if not root then return end

    -- Reset text if enabled
    if isEnabled then
        toggleBtn.Text = "SNIPER: READY"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
    end

    -- Listen for the un-anchor event (Round Start)
    connection = root:GetPropertyChangedSignal("Anchored"):Connect(function()
        -- Only fire if we just got unanchored AND the script is on
        if not root.Anchored and isEnabled then
            executeKill()
        end
    end)
end

-- Init Listeners
if player.Character then 
    setupCharacter(player.Character) 
end

player.CharacterAdded:Connect(setupCharacter)

-- Toggle Logic
toggleBtn.MouseButton1Click:Connect(function()
    isEnabled = not isEnabled
    if isEnabled then
        toggleBtn.Text = "SNIPER: READY"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        -- If we toggle it on mid-round and we aren't anchored, maybe you want to kill immediately?
        -- Uncomment next line if you want immediate kill when toggling ON during a live round:
        -- if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and not player.Character.HumanoidRootPart.Anchored then executeKill() end
    else
        toggleBtn.Text = "SNIPER: OFF"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    end
end)

-- Cleanup
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.P then
        isEnabled = false
        if connection then connection:Disconnect() end
        if screenGui then screenGui:Destroy() end
    end
end)
